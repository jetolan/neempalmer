


from semantics3 import Products
from time import sleep
import pickle
import semantics
import os

def get_offer(company, sem3_id):
 sem3=semantics.apikey()

 #sem3_id='4buXkdTf9sWCi0OIsYAIuS'
 #company='fitbit'

 # Build the request
 sem3.offers_field("sem3_id", sem3_id)
 sem3.offers_field("isotime", 1)
 sem3.offers_field("offset", 0)

 # Run the request
 #results = sem3.get_products()
 results = sem3.get_offers()

 #this is how many results were
 #found for the query
 print 'There are this many entries for your query: '+str(results['total_results_count'])

 # Specify a cache size
 sem3.cache(5)

 # Iterate through the results
 page_no = 0
 no_pages=(int(results['total_results_count']))/int(results['results_count'])
 data=[]
 for i in range(no_pages):
     results = sem3.get_offers()
     print "We are at page = %s" % page_no
     #print "The results for this page are:"
     #print results['results']

     #append to results
     for r in results['results']:
         data.append(r)

     #increment by 1
     page_no += 1
     sem3.offers_field("offset", i*int(results['results_count']))
     sleep(1) #respect rate limit


 #now make variables from dictionary:
 avail=[]
 condition=[]
 currency=[]
 firstrecorded_at=[]
 id=[]
 lastrecorded_at=[]
 price=[]
 seller=[]
 shipping=[]
 sitedetails_name=[]
 sku=[]


 for offer in data:
    avail.append(str(offer['availability'].encode('ascii','ignore')))
    condition.append(str(offer['condition'].encode('ascii','ignore')))
    currency.append(str(offer['currency'].encode('ascii','ignore')))
    first_recorded_at.append(str(offer['firstrecorded_at'].encode('ascii','ignore'))) 
    last_recorded_at.append(str(offer['lastrecorded_at'].encode('ascii','ignore')))
    id.append(str(offer['id'].encode('ascii','ignore')))
    price.append(str(offer['price'].encode('ascii','ignore')))
    seller.append(str(offer['seller'].encode('ascii','ignore')))
    sitedetails_name.append(str(offer['sitdetails_name'].encode('ascii','ignore')))
    sku.append(str(offer['sky'].encode('ascii','ignore')))
    
 head="""'SELLER, PRICE, CONDITION, CURRENCY, ID, AVAILABILITY, FIRSTRECORDED, LASTRECORDED, SITEDETAILS_NAME, SKU'""" 
 

 #-----#
 
     
 #if directory doesn't exist, make it
 directory=str("../data/"+company)
 if not os.path.exists(directory):
  os.makedirs(directory)

 #fname= directory+"/"+sem3_id+".p"
 fname= directory+"/"+sem3_id+".csv"
 print "saving "+fname+"..."
 #pickle.dump(data, open(fname, "wb" ) )
 np.savetxt(str(fname), np.column_stack((seller, price, condition, currency, id, avail, firstrecorded, lastrecorded, sitedeails_name, sku)), delimiter=", ", fmt='%s', header=head)  
 


###################################

if __name__ == "__main__":
    import sys

    try:
        arg1 = sys.argv[1]
        arg2 = sys.argv[2]
    except IndexError:
        print "Usage: get_offer.py <arg1> <arg2>"
        sys.exit(1)      

    get_offer(sys.argv[1], sys.argv[2]) 
